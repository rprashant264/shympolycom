<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vendors</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .inventory-table { padding: 5% 5%; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .table-header { background-color: #f8f9fa; font-weight: 600; }
    .table-responsive { border-radius: 8px; }
    .page-wrapper { padding: 1.5rem 0; }
  </style>
</head>
<body>
  <%- include('partials/nav', { current: 'vendors' }) %>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Vendors</h3>
      <button id="newVendorBtn" class="btn btn-primary">New Vendor</button>
    </div>

    <div class="table-responsive inventory-table">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Vendor_ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Products</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (typeof vendors !== 'undefined' && vendors.length) { %>
            <% vendors.forEach(v => { %>
              <tr data-id="<%= v._id %>" data-products="<%= (v.products || []).join(',') %>">
                <td><%= v.vendorId %></td>
                <td><%= v.name %></td>
                <td><%= v.email || '' %></td>
                <td><%= v.phone || '' %></td>
                <td><%= (v.products || []).length %></td>
                <td>
                  <button class="btn btn-sm btn-outline-primary me-1 btn-edit">Edit</button>
                  <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr><td colspan="6" class="text-center">No vendors yet</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Vendor Modal -->
  <div class="modal fade" id="vendorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="vendorForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Vendor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="vendorError" class="alert alert-danger d-none"></div>
          <div class="mb-3"><label class="form-label">Name</label><input name="name" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Email</label><input name="email" class="form-control"></div>
          <div class="mb-3"><label class="form-label">Phone</label><input name="phone" class="form-control"></div>
          <div class="mb-3"><label class="form-label">Address</label><input name="address" class="form-control"></div>
          <div class="mb-3">
            <label class="form-label">Products (choose which products this vendor supplies)</label>
            <div id="vendorProductsCheckboxes"></div>
            <small class="text-muted">Select products by checking the boxes</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const newVendorBtn = document.getElementById('newVendorBtn');
    const vendorModalEl = document.getElementById('vendorModal');
    const vendorForm = document.getElementById('vendorForm');
    const vendorError = document.getElementById('vendorError');
    const vendorProductsCheckboxes = document.getElementById('vendorProductsCheckboxes');
    const vendorsTbody = document.querySelector('tbody');
    let editingVendorId = null;

    // Open modal for new vendor
    newVendorBtn.addEventListener('click', async () => {
      editingVendorId = null;
      vendorForm.reset();
      document.querySelector('.modal-title').textContent = 'Add Vendor';
      vendorError.classList.add('d-none');

      // Fetch products only for "Add Vendor"
      try {
        const res = await fetch('/api/products');
        if (!res.ok) return;
        const products = await res.json();
        vendorProductsCheckboxes.innerHTML = products.map(p => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${p._id}" id="product_${p._id}" name="products">
            <label class="form-check-label" for="product_${p._id}">${p.productName} (${p.hsnCode})</label>
          </div>
        `).join('');
      } catch (e) { console.error(e); }

      const modal = new bootstrap.Modal(vendorModalEl);
      modal.show();
    });

    // Save vendor (Add / Edit)
    vendorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(vendorForm));
      const selected = Array.from(vendorProductsCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(o => o.value);
      data.products = selected;
      vendorError.classList.add('d-none');

      try {
        let res, result;
        if (editingVendorId) {
          res = await fetch(`/vendors/${editingVendorId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch('/vendors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Operation failed');
        }

        result = await res.json();
        bootstrap.Modal.getInstance(vendorModalEl).hide();

        // Update UI
        if (editingVendorId) {
          const row = vendorsTbody.querySelector(`tr[data-id="${editingVendorId}"]`);
          if (row) {
            row.innerHTML = `
              <td>${result.vendorId}</td>
              <td>${result.name}</td>
              <td>${result.email || ''}</td>
              <td>${result.phone || ''}</td>
              <td>${(result.products || []).length}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-1 btn-edit">Edit</button>
                <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
              </td>
            `;
          }
        } else {
          const row = document.createElement('tr');
          row.dataset.id = result._id;
          row.dataset.products = (result.products || []).join(',');
          row.innerHTML = `
            <td>${result.vendorId}</td>
            <td>${result.name}</td>
            <td>${result.email || ''}</td>
            <td>${result.phone || ''}</td>
            <td>${(result.products || []).length}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1 btn-edit">Edit</button>
              <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
            </td>
          `;
          vendorsTbody.appendChild(row);
        }

        vendorForm.reset();
        editingVendorId = null;

      } catch (err) {
        vendorError.textContent = err.message;
        vendorError.classList.remove('d-none');
      }
    });

    // Handle edit / delete buttons
    vendorsTbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = btn.closest('tr');
      const id = tr.dataset.id;

      // Delete vendor
      if (btn.classList.contains('btn-delete')) {
        if (!confirm('Delete this vendor?')) return;
        try {
          const res = await fetch(`/vendors/${id}`, { method: 'DELETE' });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Delete failed');
          }
          tr.remove();
        } catch (err) {
          alert(err.message || 'Delete failed');
        }
        return;
      }

      // Edit vendor
      if (btn.classList.contains('btn-edit')) {
        try {
          const res = await fetch(`/api/vendors`);
          if (!res.ok) throw new Error('Failed to load vendors');
          const vendors = await res.json();
          const v = vendors.find(x => String(x._id) === id);
          if (!v) throw new Error('Vendor not found');

          // Populate form
          vendorForm.querySelector('input[name="name"]').value = v.name || '';
          vendorForm.querySelector('input[name="email"]').value = v.email || '';
          vendorForm.querySelector('input[name="phone"]').value = v.phone || '';
          vendorForm.querySelector('input[name="address"]').value = v.address || '';

          // Load and pre-check products
          const prodRes = await fetch('/api/products');
          if (prodRes.ok) {
            const products = await prodRes.json();
            vendorProductsCheckboxes.innerHTML = products.map(p => `
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${p._id}" id="product_${p._id}" name="products">
                <label class="form-check-label" for="product_${p._id}">${p.productName} (${p.hsnCode})</label>
              </div>
            `).join('');

            // Mark selected checkboxes
            Array.from(vendorProductsCheckboxes.querySelectorAll('input[type="checkbox"]')).forEach(opt => {
              opt.checked = (v.products || []).includes(opt.value);
            });
          }

          editingVendorId = id;
          document.querySelector('.modal-title').textContent = 'Edit Vendor';
          vendorError.classList.add('d-none');

          const modal = new bootstrap.Modal(vendorModalEl);
          modal.show();

        } catch (err) {
          console.error(err);
          alert('Failed to prepare edit');
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
