<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Home</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
            :root{ --accent1:#6C5CE7; --accent2:#00B894; --muted:#6c757d }
            body{ font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#f5f7fb 0%, #ffffff 100%); }
            .hero{ background: linear-gradient(90deg, rgba(108,92,231,0.08), rgba(0,184,148,0.04)); border-radius: 12px; padding: 1.25rem; display:flex; gap:1rem; align-items:center }
            .hero .title { font-weight:700; color:#222; font-size:1.25rem }
            .card.gradient { border:0; color:#fff }
            .card.gradient .card-body{ background: linear-gradient(135deg, var(--accent1), #00A8E8); border-radius:10px }
            .small-muted{ color:var(--muted); font-size:0.9rem }
            .stat-value{ font-weight:700; font-size:1.75rem }
            .chart-card{ min-height:180px }
        </style>
</head>
<body>
                <!-- Shared Navigation Bar -->
                <%- include('partials/nav', { current: 'home' }) %>

                <div class="container mt-4">
                    <div class="hero mb-3">
                        <div style="flex:1">
                            <div class="title">Welcome back</div>
                            <div class="small-muted">Quick insights from your store</div>
                        </div>
                        <div style="width:90px; height:90px; display:flex;align-items:center;justify-content:center">
                            <!-- decorative SVG -->
                            <svg width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><rect rx="12" width="72" height="72" fill="#6C5CE7"/><path d="M18 44c6-12 14-14 24-8" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>

                    <div class="row gy-3">
                        <div class="col-md-3">
                            <div class="card gradient shadow-sm">
                                <div class="card-body">
                                    <div class="small-muted">Total Products</div>
                                    <div class="stat-value"><%= dashboard && dashboard.totalProducts ? dashboard.totalProducts : 0 %></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="small-muted">Sales This Month</div>
                                    <div class="stat-value">₹<%= dashboard && dashboard.salesThisMonth ? Number(dashboard.salesThisMonth).toFixed(2) : '0.00' %></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="small-muted">Purchases This Month</div>
                                    <div class="stat-value">₹<%= dashboard && dashboard.purchasesThisMonth ? Number(dashboard.purchasesThisMonth).toFixed(2) : '0.00' %></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="small-muted">Low Stock Items</div>
                                    <div class="stat-value"><%= dashboard && dashboard.lowStock ? dashboard.lowStock.length : 0 %></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-lg-8">
                            <div class="card chart-card shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Top Selling Products</h5>
                                        <div>
                                            <div class="btn-group btn-group-sm" role="group" aria-label="metric toggle">
                                                <button id="metricUnits" class="btn btn-outline-primary active">Units</button>
                                                <button id="metricAmount" class="btn btn-outline-primary">Amount</button>
                                            </div>
                                        </div>
                                    </div>
                                      <canvas id="topProductsChart" style="height:160px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Low Stock Products</h5>
                                    <ul class="list-group list-group-flush">
                                        <% if (dashboard && dashboard.lowStock && dashboard.lowStock.length) { %>
                                            <% dashboard.lowStock.forEach(p => { %>
                                                <li class="list-group-item d-flex justify-content-between align-items-center"><div><strong><%= p.productName %></strong><div class="small-muted">HSN: <%= p.hsnCode %></div></div><span class="badge bg-danger rounded-pill"><%= p.stock %></span></li>
                                            <% }); %>
                                        <% } else { %>
                                            <li class="list-group-item">No low stock items</li>
                                        <% } %>
                                    </ul>
                                </div>
                            </div>
                            <div class="card mt-3 shadow-sm">
                                <div class="card-body">
                                    <h6 class="mb-2">Sales vs Purchases (This Month)</h6>
                                    <canvas id="salesDonut" style="height:180px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6>Recent Sales</h6>
                                    <ul class="list-group list-group-flush">
                                        <% if (dashboard && dashboard.recentSales && dashboard.recentSales.length) { %>
                                            <% dashboard.recentSales.forEach(s => { %>
                                                <li class="list-group-item"><strong><%= s.productName %></strong> — <%= s.units %> units <span class="small-muted float-end">₹<%= Number(s.amount||0).toFixed(2) %></span></li>
                                            <% }); %>
                                        <% } else { %>
                                            <li class="list-group-item">No recent sales</li>
                                        <% } %>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6>Recent Purchases</h6>
                                    <ul class="list-group list-group-flush">
                                        <% if (dashboard && dashboard.recentPurchases && dashboard.recentPurchases.length) { %>
                                            <% dashboard.recentPurchases.forEach(p => { %>
                                                <li class="list-group-item"><strong><%= p.productName %></strong> — <%= p.units %> units <span class="small-muted float-end">₹<%= Number(p.amount||0).toFixed(2) %></span></li>
                                            <% }); %>
                                        <% } else { %>
                                            <li class="list-group-item">No recent purchases</li>
                                        <% } %>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Chart.js and interactivity -->
                <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
                <script>
                    (function(){
                        const top = <%- JSON.stringify((dashboard && dashboard.topProducts) || []) %>;
                        const salesThisMonth = <%- JSON.stringify(dashboard && dashboard.salesThisMonth ? Number(dashboard.salesThisMonth) : 0) %>;
                        const purchasesThisMonth = <%- JSON.stringify(dashboard && dashboard.purchasesThisMonth ? Number(dashboard.purchasesThisMonth) : 0) %>;

                        const labels = top.map(t => t.productName || (t._id || '').toString());
                        const unitsData = top.map(t => t.units || 0);
                        const amountData = top.map(t => Math.round(t.amount || 0));

                        const ctx = document.getElementById('topProductsChart').getContext('2d');
                        let currentMetric = 'units';
                                    const barConfig = {
                                        type: 'bar',
                                        data: { labels, datasets: [{ label: 'Units sold', data: unitsData, backgroundColor: labels.map((_,i)=> `hsl(${220 - i*12} 70% 55%)`) }] },
                                        options: { responsive:true, maintainAspectRatio:true, aspectRatio: 2, plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } }, scales:{ y:{ beginAtZero:true } } }
                                    };
                        const topChart = new Chart(ctx, barConfig);

                        // donut chart
                        const donutCtx = document.getElementById('salesDonut').getContext('2d');
                                    const donut = new Chart(donutCtx, {
                                        type: 'doughnut',
                                        data: { labels:['Sales','Purchases'], datasets:[{ data:[salesThisMonth, purchasesThisMonth], backgroundColor:['#36A2EB','#FF6384'] }] },
                                        options:{ plugins:{ legend:{ position:'bottom' } }, maintainAspectRatio:true, aspectRatio: 1.2 }
                                    });

                        // metric toggle
                        const btnUnits = document.getElementById('metricUnits');
                        const btnAmount = document.getElementById('metricAmount');
                        function setMetric(metric){
                            currentMetric = metric;
                            if(metric==='units'){
                                topChart.data.datasets[0].data = unitsData;
                                topChart.data.datasets[0].label = 'Units sold';
                                btnUnits.classList.add('active'); btnAmount.classList.remove('active');
                            } else {
                                topChart.data.datasets[0].data = amountData;
                                topChart.data.datasets[0].label = 'Amount (₹)';
                                btnAmount.classList.add('active'); btnUnits.classList.remove('active');
                            }
                            topChart.update();
                        }
                        btnUnits.addEventListener('click', ()=> setMetric('units'));
                        btnAmount.addEventListener('click', ()=> setMetric('amount'));
                    })();
                </script>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
