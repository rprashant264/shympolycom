<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        /* Table Styles */
        .inventory-table {
            padding: 5% 5%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .table-responsive {
            border-radius: 8px;
           
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <%- include('partials/nav', { current: 'inventory' }) %>

    <!-- Inventory Section -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Inventory Management</h2>
            <!--<button id="openAddModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                <i class="fas fa-plus me-2"></i>Add New Item
            </button>-->
        </div>
        
        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by HSN Code or Product Name...">
                    <button class="btn btn-outline-secondary" type="button" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive inventory-table">
            <table class="table table-hover mb-0">
                <thead class="table-header">
                    <tr>
                        <th>HSN Code</th>
                        <th>Product Name</th>
                        <th>Cost</th>
                        <th>Produced Units</th>
                        <th>Sold Units</th>
                        <th>Stock Units</th>
                        <th>Stock Amt</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <!-- Render rows from server-provided items -->
                    <% if (typeof items !== 'undefined' && Array.isArray(items) && items.length) { %>
                        <% items.forEach(function(item){ %>
                            <tr data-id="<%= item._id %>">
                                <td><%= item.hsnCode %></td>
                                <td><%= item.productName %></td>
                                <td>₹<%= Number(item.cost).toFixed(2) %></td>
                                <td><%= item.purchaseUnits %></td>
                                <td><%= item.saleUnits %></td>
                                <td><%= item.stock %></td>
                                <td>₹<%= item.stockAmount.toLocaleString() %></td>
                                <td>
                                    <!--<button class="btn btn-sm btn-outline-primary me-1 btn-edit">
                                        <i class="fas fa-edit"></i>
                                    </button>-->
                                    <button class="btn btn-sm btn-outline-danger btn-delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="8" class="text-center">No items yet</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <!-- changed: use the route that exists on the server -->
        <form id="addItemForm"class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div id="addItemError" class="alert alert-danger d-none"></div>

              <div class="mb-3">
                  <label class="form-label">HSN Code</label>
                  <input name="hsnCode" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Product Name</label>
                  <input name="productName" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Cost (per unit)</label>
                  <input name="cost" type="number" step="0.01" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Purchase Units</label>
                  <input name="purchaseUnits" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Sale Units</label>
                  <input name="saleUnits" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Stock</label>
                  <input name="stock" type="number" class="form-control" value="0" required />
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form id="editItemForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div id="editItemError" class="alert alert-danger d-none"></div>
              <input type="hidden" name="itemId" id="editItemId">
              
              <div class="mb-3">
                  <label class="form-label">HSN Code</label>
                  <input name="hsnCode" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Product Name</label>
                  <input name="productName" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Cost (per unit)</label>
                  <input name="cost" type="number" step="0.01" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Purchase Units</label>
                  <input name="purchaseUnits" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Sale Units</label>
                  <input name="saleUnits" class="form-control" required />
              </div>
              <div class="mb-3">
                  <label class="form-label">Stock</label>
                  <input name="stock" type="number" class="form-control" required />
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get DOM elements
        const addItemModal = document.getElementById('addItemModal');
        const addItemForm = document.getElementById('addItemForm');
        const addItemError = document.getElementById('addItemError');
        const inventoryBody = document.getElementById('inventoryBody');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const editItemModal = document.getElementById('editItemModal');
        const editItemForm = document.getElementById('editItemForm');
        const editItemError = document.getElementById('editItemError');
        
        // Store original table rows for search functionality
        let originalRows = [...inventoryBody.querySelectorAll('tr')];

        // Handle form submission
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(addItemForm);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            try {
                const response = await fetch('/inventory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add item');
                }

                const newItem = await response.json();
                
                // Add new row to table
                const row = document.createElement('tr');
                row.dataset.id = newItem._id;
                row.innerHTML = `
                    <td>${newItem.hsnCode}</td>
                    <td>${newItem.productName}</td>
                    <td>₹${Number(newItem.cost).toFixed(2)}</td>
                    <td>${newItem.purchaseUnits}</td>
                    <td>${newItem.saleUnits}</td>
                    <td>${newItem.stock}</td>
                    <td>₹${newItem.stockAmount.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 btn-edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                // If table was empty, remove the "No items yet" row
                const noItemsRow = inventoryBody.querySelector('td[colspan="8"]');
                if (noItemsRow) {
                    noItemsRow.parentElement.remove();
                }

                inventoryBody.appendChild(row);
                
                // Clear form and close modal
                addItemForm.reset();
                const modal = bootstrap.Modal.getInstance(addItemModal);
                modal.hide();
            } catch (err) {
                addItemError.textContent = err.message;
                addItemError.classList.remove('d-none');
            }
        });

        // Handle delete button clicks
        inventoryBody.addEventListener('click', async (e) => {
            if (e.target.closest('.btn-delete')) {
                const row = e.target.closest('tr');
                const id = row.dataset.id;
                
                if (confirm('Are you sure you want to delete this item?')) {
                    try {
                        const response = await fetch(`/inventory/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to delete item');
                        }

                        row.remove();

                        // If no more items, show the "No items yet" message
                        if (inventoryBody.children.length === 0) {
                            const noItemsRow = document.createElement('tr');
                            noItemsRow.innerHTML = '<td colspan="8" class="text-center">No items yet</td>';
                            inventoryBody.appendChild(noItemsRow);
                        }
                    } catch (err) {
                        alert(err.message);
                    }
                }
            }
        });

        // Clear error message when modals are hidden
        addItemModal.addEventListener('hidden.bs.modal', () => {
            addItemError.classList.add('d-none');
            addItemError.textContent = '';
            addItemForm.reset();
        });

        editItemModal.addEventListener('hidden.bs.modal', () => {
            editItemError.classList.add('d-none');
            editItemError.textContent = '';
            editItemForm.reset();
        });

        // Search functionality
        function performSearch(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const rows = [...inventoryBody.querySelectorAll('tr')];
            
            rows.forEach(row => {
                const hsnCode = row.cells[0]?.textContent.toLowerCase() || '';
                const productName = row.cells[1]?.textContent.toLowerCase() || '';
                
                if (hsnCode.includes(searchTerm) || productName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        searchButton.addEventListener('click', () => {
            performSearch(searchInput.value);
        });

        // Edit functionality
        function populateEditForm(row) {
            const cells = row.cells;
            const form = editItemForm;
            
            form.querySelector('[name="itemId"]').value = row.dataset.id;
            form.querySelector('[name="hsnCode"]').value = cells[0].textContent;
            form.querySelector('[name="productName"]').value = cells[1].textContent;
            form.querySelector('[name="cost"]').value = cells[2].textContent.replace('₹', '');
            form.querySelector('[name="purchaseUnits"]').value = cells[3].textContent;
            form.querySelector('[name="saleUnits"]').value = cells[4].textContent;
            form.querySelector('[name="stock"]').value = cells[5].textContent;
        }

        // Handle edit button clicks
        inventoryBody.addEventListener('click', async (e) => {
            if (e.target.closest('.btn-edit')) {
                const row = e.target.closest('tr');
                populateEditForm(row);
                const editModal = new bootstrap.Modal(editItemModal);
                editModal.show();
            }
        });

        // Handle edit form submission
        editItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(editItemForm);
            const itemId = formData.get('itemId');
            const data = {};
            formData.forEach((value, key) => {
                if (key !== 'itemId') {
                    data[key] = value;
                }
            });

            try {
                const response = await fetch(`/inventory/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update item');
                }

                const updatedItem = await response.json();
                
                // Update the row in the table
                const row = inventoryBody.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    row.innerHTML = `
                        <td>${updatedItem.hsnCode}</td>
                        <td>${updatedItem.productName}</td>
                        <td>₹${Number(updatedItem.cost).toFixed(2)}</td>
                        <td>${updatedItem.purchaseUnits}</td>
                        <td>${updatedItem.saleUnits}</td>
                        <td>${updatedItem.stock}</td>
                        <td>₹${updatedItem.stockAmount.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1 btn-edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(editItemModal);
                modal.hide();
            } catch (err) {
                editItemError.textContent = err.message;
                editItemError.classList.remove('d-none');
            }
        });

        // Update original rows when new item is added
        function updateOriginalRows() {
            originalRows = [...inventoryBody.querySelectorAll('tr')];
        }

        // Add observer to track changes in table body
        const observer = new MutationObserver(updateOriginalRows);
        observer.observe(inventoryBody, { childList: true, subtree: true });
    </script>
</body>
</html>
