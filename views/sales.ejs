<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        /* Table Styles */
        .inventory-table {
             padding: 5% 5%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .table-responsive {
            border-radius: 8px;
           
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <%- include('partials/nav', { current: 'sales' }) %>

    <!-- Inventory Section -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Sales Dashboard</h2>
            <button id="newSaleBtn" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Sale
            </button>
        </div>
        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="salesSearchInput" class="form-control" placeholder="Search by HSN, Product or Customer...">
                    <button class="btn btn-outline-secondary" type="button" id="salesSearchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        

        <div class="table-responsive inventory-table">
            <table class="table table-hover mb-0">
                <thead class="table-header">
                    <tr>
                        <th>Sale_ID</th>
                        <th>Cust_Name</th>
                        <th>Date</th>
                        <th>Products (Count)</th>
                        <th>Total Units</th>
                        <th>Total Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesTbody">
                  <% if (typeof sales !== 'undefined' && Array.isArray(sales) && sales.length) { %>
                                        <% sales.forEach(function(s) { %>
                                                                    <tr data-id="<%= s._id %>" data-customer-id="<%= s.customerId || '' %>" data-date="<%= s.date %>">
                                                <td><%= s.saleId %></td>
                                                <td><%= s.customerName %></td>
                                                <td><%= s.date %></td>
                                                <td><%= s.lineItems ? s.lineItems.length : 0 %></td>
                                                <td><%= s.totalUnits %></td>
                                                <td>â‚¹<%= Number(s.totalAmount).toFixed(2) %></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1 btn-edit" title="Edit"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-sm btn-outline-danger btn-delete" title="Delete"><i class="fas fa-trash"></i></button>
                                                     <button class="btn btn-sm btn-outline-success btn-print" title="Print"><i class="fas fa-print"></i></button>
                                                </td>
                                            </tr>
                                        <% }); %>
                  <% } else { %>
                    <tr><td colspan="7" class="text-center">No sales yet</td></tr>
                  <% } %>
                </tbody>
            </table>
        </div>
    </div>



        <!-- Add Sale Modal -->
        <div class="modal fade" id="addSaleModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <form id="addSaleForm" class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Sale</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="addSaleError" class="alert alert-danger d-none"></div>
                        
                        <!-- Customer Selection -->
                        <div class="mb-3">
                            <label class="form-label">Customer</label>
                            <select id="saleCustomerSelect" class="form-select"></select>
                            <input type="hidden" name="customerId" id="saleCustomerId">
                        </div>
                        
                        <!-- Date -->
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input name="date" type="date" class="form-control">
                        </div>
                        
                        <!-- Products Section -->
                        <div class="mb-3">
                            <label class="form-label">Add Products to Sale</label>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Product</label>
                                            <select id="saleProductSelect" class="form-select"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Qty</label>
                                            <input id="saleQty" type="number" class="form-control" min="1" value="1">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Price</label>
                                            <input id="salePrice" type="number" step="0.01" class="form-control" min="0">
                                        </div>
                                    </div>
                                    <button type="button" id="addProductBtn" class="btn btn-sm btn-success">
                                        <i class="fas fa-plus me-1"></i>Add Product
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Line Items Display -->
                        <div class="mb-3">
                            <label class="form-label">Products in this Sale</label>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="lineItemsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Product</th>
                                            <th>HSN</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Amount</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lineItemsBody">
                                        <tr id="emptyMsg"><td colspan="6" class="text-center text-muted">No products added yet</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                <span>Total: <strong>â‚¹<span id="totalAmount">0.00</span></strong></span>
                                <span>Units: <strong><span id="totalUnits">0</span></strong></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Sale</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const newSaleBtn = document.getElementById('newSaleBtn');
            const addSaleForm = document.getElementById('addSaleForm');
            const addSaleError = document.getElementById('addSaleError');
            const salesTbody = document.getElementById('salesTbody');
            const saleProductSelect = document.getElementById('saleProductSelect');
            const saleQty = document.getElementById('saleQty');
            const salePrice = document.getElementById('salePrice');
            const addProductBtn = document.getElementById('addProductBtn');
            const lineItemsBody = document.getElementById('lineItemsBody');
            const lineItemsTable = document.getElementById('lineItemsTable');
            const totalAmountSpan = document.getElementById('totalAmount');
            const totalUnitsSpan = document.getElementById('totalUnits');
            const saleCustomerSelect = document.getElementById('saleCustomerSelect');
            const saleCustomerId = document.getElementById('saleCustomerId');

            // Search elements for sales
            const salesSearchInput = document.getElementById('salesSearchInput');
            const salesSearchButton = document.getElementById('salesSearchButton');

            // Store line items temporarily during edit
            let lineItems = [];
            let editingSaleId = null;

            const addSaleModalEl = document.getElementById('addSaleModal');

            // Update price field when product changes
            saleProductSelect.addEventListener('change', (e) => {
                const opt = e.target.selectedOptions[0];
                if (opt && opt.value) {
                    salePrice.value = opt.dataset.price || '';
                } else {
                    salePrice.value = '';
                }
            });

            // Add product to line items
            addProductBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const productOpt = saleProductSelect.selectedOptions[0];
                if (!productOpt || !productOpt.value) {
                    alert('Please select a product');
                    return;
                }
                const qty = parseInt(saleQty.value) || 0;
                const price = parseFloat(salePrice.value) || 0;
                
                if (qty <= 0) { alert('Quantity must be > 0'); return; }
                if (price < 0) { alert('Price cannot be negative'); return; }

                const lineItem = {
                    productRef: productOpt.value,
                    hsnCode: productOpt.dataset.hsn || '',
                    productName: productOpt.textContent,
                    units: qty,
                    price: price,
                    amount: qty * price
                };

                lineItems.push(lineItem);
                renderLineItems();
                saleProductSelect.value = '';
                saleQty.value = '1';
                salePrice.value = '';
                saleProductSelect.focus();
            });

            function renderLineItems() {
                lineItemsBody.innerHTML = '';
                if (lineItems.length === 0) {
                    lineItemsBody.innerHTML = '<tr id="emptyMsg"><td colspan="6" class="text-center text-muted">No products added yet</td></tr>';
                } else {
                    let totalAmount = 0;
                    let totalUnits = 0;
                    lineItems.forEach((item, idx) => {
                        totalAmount += item.amount;
                        totalUnits += item.units;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.productName}</td>
                            <td>${item.hsnCode}</td>
                            <td>${item.units}</td>
                            <td>â‚¹${Number(item.price).toFixed(2)}</td>
                            <td>â‚¹${Number(item.amount).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-item" data-idx="${idx}"><i class="fas fa-trash"></i></button></td>
                        `;
                        lineItemsBody.appendChild(row);
                    });
                    totalAmountSpan.textContent = totalAmount.toFixed(2);
                    totalUnitsSpan.textContent = totalUnits;
                }
            }

            // Remove line item
            lineItemsBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-remove-item');
                if (btn) {
                    const idx = parseInt(btn.dataset.idx);
                    lineItems.splice(idx, 1);
                    renderLineItems();
                }
            });

            function performSalesSearch(term) {
                term = (term || '').toLowerCase();
                const rows = [...salesTbody.querySelectorAll('tr')];
                rows.forEach(row => {
                    if (row.querySelector('td[colspan]')) {
                        row.style.display = term ? 'none' : '';
                        return;
                    }
                    const cells = row.cells;
                    const saleId = (cells[0]?.textContent || '').toLowerCase();
                    const custName = (cells[1]?.textContent || '').toLowerCase();
                    const products = (cells[3]?.textContent || '').toLowerCase();
                    if (saleId.includes(term) || custName.includes(term) || products.includes(term)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            if (salesSearchInput) salesSearchInput.addEventListener('input', (e) => performSalesSearch(e.target.value));
            if (salesSearchButton) salesSearchButton.addEventListener('click', () => performSalesSearch(salesSearchInput.value));

            // Modal show event
            addSaleModalEl.addEventListener('show.bs.modal', async () => {
                if (editingSaleId) return; // Keep line items for editing
                
                lineItems = [];
                renderLineItems();
                
                try {
                    const [pRes, cRes] = await Promise.all([fetch('/api/products'), fetch('/api/customers')]);
                    if (pRes.ok) {
                        const products = await pRes.json();
                        saleProductSelect.innerHTML = '<option value="">-- Select product --</option>' + products.map(p => `<option value="${p._id}" data-hsn="${p.hsnCode}" data-price="${p.sellingPrice || p.cost || 0}">${p.productName} (${p.hsnCode})</option>`).join('');
                    }
                    if (cRes.ok) {
                        const customers = await cRes.json();
                        saleCustomerSelect.innerHTML = '<option value="">-- Select customer --</option>' + customers.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
                    }
                } catch (err) {
                    console.error('Failed to load data for modal', err);
                }
            });

            // Modal hidden event
            addSaleModalEl.addEventListener('hidden.bs.modal', () => {
                if (!editingSaleId) {
                    editingSaleId = null;
                    lineItems = [];
                    renderLineItems();
                }
                const title = addSaleModalEl.querySelector('.modal-title');
                if (title) title.textContent = 'Add Sale';
                const submitBtn = addSaleModalEl.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Save Sale';
                addSaleError.classList.add('d-none');
            });

            saleCustomerSelect.addEventListener('change', (e) => {
                const opt = e.target.selectedOptions[0];
                saleCustomerId.value = opt && opt.value ? opt.value : '';
            });

            // New Sale button
            if (newSaleBtn) {
                newSaleBtn.addEventListener('click', () => {
                    editingSaleId = null;
                    lineItems = [];
                    addSaleForm.reset();
                    const modal = new bootstrap.Modal(addSaleModal);
                    modal.show();
                });
            }

            // Form submit
            addSaleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (lineItems.length === 0) {
                    alert('Please add at least one product');
                    return;
                }
                
                const customerId = saleCustomerId.value;
                const date = addSaleForm.querySelector('input[name="date"]').value;
                
                if (!customerId) {
                    alert('Please select a customer');
                    return;
                }

                const data = {
                    customerId,
                    date: date || new Date().toISOString().split('T')[0],
                    lineItems
                };

                try {
                    if (editingSaleId) {
                        const res = await fetch(`/sales/${editingSaleId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.error || 'Failed to update sale');
                        }
                        location.reload();
                        return;
                    }

                    const res = await fetch('/sales', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Failed to create sale');
                    }
                    location.reload();
                } catch (err) {
                    addSaleError.textContent = err.message;
                    addSaleError.classList.remove('d-none');
                }
            });

            // Delegate edit/delete actions
            salesTbody.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const tr = btn.closest('tr');
                const id = tr.dataset.id;

                if (btn.classList.contains('btn-delete')) {
                    if (!confirm('Delete this sale?')) return;
                    try {
                        const res = await fetch(`/sales/${id}`, { method: 'DELETE' });
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.error || 'Failed to delete');
                        }
                        tr.remove();
                    } catch (err) {
                        alert(err.message || 'Delete failed');
                    }
                }

                if (btn.classList.contains('btn-edit')) {
                    try {
                        const res = await fetch(`/sales/${id}`);
                        if (!res.ok) throw new Error('Failed to load sale');
                        const sale = await res.json();
                        
                        // Populate line items
                        lineItems = (sale.lineItems || []).map(item => ({
                            productRef: item.productRef && item.productRef._id ? item.productRef._id : item.productRef,
                            hsnCode: item.hsnCode,
                            productName: item.productName,
                            units: item.units,
                            price: item.price,
                            amount: item.amount
                        }));
                        
                        // Load products/customers
                        const [pRes, cRes] = await Promise.all([fetch('/api/products'), fetch('/api/customers')]);
                        if (pRes.ok) {
                            const products = await pRes.json();
                            saleProductSelect.innerHTML = '<option value="">-- Select product --</option>' + products.map(p => `<option value="${p._id}" data-hsn="${p.hsnCode}" data-price="${p.sellingPrice || p.cost || 0}">${p.productName} (${p.hsnCode})</option>`).join('');
                        }
                        if (cRes.ok) {
                            const customers = await cRes.json();
                            saleCustomerSelect.innerHTML = '<option value="">-- Select customer --</option>' + customers.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
                        }

                        // Set form values
                        if (saleCustomerSelect.querySelector(`option[value="${sale.customerId && sale.customerId._id ? sale.customerId._id : sale.customerId}"]`)) {
                            saleCustomerSelect.value = sale.customerId && sale.customerId._id ? sale.customerId._id : sale.customerId;
                        }
                        const dateField = addSaleForm.querySelector('input[name="date"]');
                        if (dateField && sale.date) {
                            dateField.value = sale.date.split('T')[0];
                        }
                        
                        editingSaleId = id;
                        renderLineItems();
                        const title = addSaleModalEl.querySelector('.modal-title');
                        if (title) title.textContent = 'Edit Sale';
                        const submitBtn = addSaleModalEl.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Save Changes';
                        const modal = new bootstrap.Modal(addSaleModalEl);
                        modal.show();
                    } catch (err) {
                        console.error('Failed to load sale for edit', err);
                        alert('Failed to load sale');
                    }
                }
            });


// ðŸ–¨ PRINT SALE DETAILS (Professional Layout)
salesTbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const tr = btn.closest('tr');
    const id = tr.dataset.id;

    if (btn.classList.contains('btn-print')) {
        try {
            const res = await fetch(`/sales/${id}`);
            if (!res.ok) throw new Error('Failed to load sale');
            const sale = await res.json();

            // Generate printable invoice HTML
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Sale Invoice - ${sale.saleId}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
                    <style>
                        body {
                            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                            background: #fff;
                            color: #000;
                            padding: 40px;
                        }
                        .invoice-container {
                            max-width: 850px;
                            margin: auto;
                            background: #fff;
                            border: 1px solid #dee2e6;
                            border-radius: 10px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            padding: 40px;
                        }
                        .invoice-header {
                            text-align: center;
                            border-bottom: 3px solid #0d6efd;
                            padding-bottom: 15px;
                            margin-bottom: 25px;
                        }
                        .invoice-header h2 {
                            color: #0d6efd;
                            font-weight: 700;
                            margin-bottom: 5px;
                        }
                        .invoice-header p {
                            margin: 0;
                            font-size: 14px;
                            color: #555;
                        }
                        .invoice-details p {
                            margin: 3px 0;
                            font-size: 15px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 25px;
                        }
                        th, td {
                            border: 1px solid #dee2e6;
                            padding: 8px 10px;
                            text-align: left;
                        }
                        th {
                            background-color: #f8f9fa;
                            font-weight: 600;
                            text-align: center;
                        }
                        td {
                            text-align: center;
                        }
                        tr:nth-child(even) {
                            background-color: #fafafa;
                        }
                        .summary {
                            margin-top: 30px;
                            text-align: right;
                            font-size: 16px;
                            font-weight: 600;
                        }
                        .signature-section {
                            margin-top: 70px;
                            display: flex;
                            justify-content: space-between;
                            font-size: 15px;
                        }
                        .signature-box {
                            width: 45%;
                            text-align: center;
                            padding-top: 50px;
                            border-top: 1px solid #000;
                        }
                        .print-btn {
                            display: block;
                            width: fit-content;
                            margin: 40px auto 0;
                        }
                        @media print {
                            .print-btn { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="invoice-header">
                            <h2>SALE INVOICE</h2>
                            <p><strong>Invoice #:</strong> ${sale.saleId}</p>
                        </div>

                        <div class="invoice-details">
                            <p><strong>Customer ID:</strong> ${sale.customerId || ''}</p>
                            <p><strong>Customer Name:</strong> ${''}</p>
                            <p><strong>Date:</strong> ${new Date(sale.date).toLocaleDateString()}</p>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product</th>
                                    <th>Boxes</th>
                                    <th>Weight/Unit</th>
                                    <th>Rate/Unit (â‚¹)</th>
                                    <th>Amount (â‚¹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(sale.lineItems || []).map((item, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${item.productName || ''}</td>
                                        <td>${item.units}</td>
                                        <td>${item.productWeight ? (item.productWeight * item.units).toFixed(3) : '-'}</td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                    <div class="summary" style="text-align: left; margin-top: 30px;">
                        <p><strong>Total Units:</strong> ${sale.totalUnits || ''}</p>
                        <p><strong>Total Weight (kg):</strong> ${
                            (sale.lineItems || [])
                              .reduce((acc, item) => acc + ((item.productWeight || 0) * (item.units || 0)), 0)
                              .toFixed(3)
                        }</p>
                        <p><strong>Total Amount (â‚¹):</strong> ${''}</p>
                    </div>


                        <div class="signature-section">
                            <div class="signature-box">Customer Signature</div>
                            <div class="signature-box">Authorized Signature</div>
                        </div>

                        <button class="btn btn-success print-btn" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Print Invoice
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        } catch (err) {
            console.error('Print failed', err);
            alert('Failed to load sale details for printing');
        }
    }
});


        </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
